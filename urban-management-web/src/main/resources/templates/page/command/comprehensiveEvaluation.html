<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>热线上报</title>
    <th:block th:include="page/fragments/common :: common_css"/>
    <th:block th:include="page/fragments/common :: fileUpload_css"/>
    <th:block th:include="page/fragments/common :: bootstrap_table_css"/>
    <th:block th:include="page/fragments/common :: bootstrap_datepicker_css"/>
    <th:block th:include="page/fragments/common :: swiper_css" />
    <link th:href="@{/css/comprehensiveEvaluation.css}" rel="stylesheet" type="text/css">
</head>

<body>
<div class="warp">
    <div class="linebox">
        <div class="line_box_rell">
            <div class="buttons">
                <div class="times">
                    <div class="titleone">轨迹回放:</div>
                    <div class="titleorther">2020/11/23</div>
                    <div class="titleorther">18:20</div>
                </div>
                <div class="controls">
                    <div class="start" id="start-animation"></div>
                    <div class="stop" id="stop"></div>
                    <div class="write" id="wait"></div>
                </div>
                <div class="close">
                    <i class="closelogo"></i>
                </div>
            </div>
            <div class="sport">
                <div class="sport_line">
                    <div class="timestart">开始</div>
                    <div class="timeend">结束</div>

                    <div class="startPoint"></div>
                    <div class="endPoint"></div>
                    <div class="centerPoint"></div>


                    <div class="line_time">
                        <div class="contorl_times">
                            <div class="startTimes">8:00</div>
                            <div class="endTimes">18:00</div>
                            <div class="centerTimes">12:00</div>
                        </div>
                    </div>

                    <div class="sportPoint" id="sportPoint"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="map_box">

        <div class="map" id="map" style="width: 100%;height: 100%"></div>
<!--        <div class="follMap">-->

<!--        </div>-->
    </div>
</div>
</body>


</div>
<th:block th:include="page/fragments/common :: common_js"/>
<th:block th:include="page/fragments/common :: jquery_validation_js"/>
<th:block th:include="page/fragments/common :: fileUpload_js"/>
<th:block th:include="page/fragments/common :: map_js"/>
<th:block th:include="page/fragments/common :: bootstrap_table_js"/>
<th:block th:include="page/fragments/common :: bootstrap_datepicker_js"/>
<th:block th:include="page/fragments/common :: swiper_js"/>
<script type="text/javascript" th:inline="javascript">
    $(function () {

        var center = ol.proj.transform([113.28523708519815, 31.22223383481966], "EPSG:3857", "EPSG:4326");
        var raster = new ol.layer.Tile({
            source: new ol.source.OSM()
        });
        var source = new ol.source.Vector({
            wrapX: false
        });
        //ol.layer.Vector用于显示在客户端渲染的矢量数据。
        var vector = new ol.layer.Vector({
            source: source
        });
        var map = new ol.Map({
            target: 'map',
            layers: [raster, vector],
            view: new ol.View({
                // projection : projection,
                center: center,
                zoom: 20,

            })
        });

        var layer = new ol.layer.Vector({
            source: new ol.source.Vector(),
        });
        var coordinates = [
            [104.06250000000001, 30.65681556429287],
            [104.23659653944907, 30.67396833485058],
            [104.4107544999246, 30.690888911014596],
            [104.58497310591778, 30.70757705503652],
            [104.75925157857333, 30.724032532190993],
            [104.93358913572729, 30.740255110788784],
            [105.10798499194534, 30.75624456218971],
            [105.28243835856125, 30.772000660815337],
            [105.45694844371592, 30.787523184161603],
            [105.63151445239656, 30.80281191281125],
            [105.80613558647657, 30.817866630446186],
            [105.98081104475536, 30.8326871238596],
            [106.15554002299895, 30.847273182967992],
            [106.33032171398055, 30.861624600823],
            [106.50515530752187, 30.875741173623137],
            [106.68003999053437, 30.889622700725297],
            [106.85497494706121, 30.90326898465615],
            [107.02995935831927, 30.916679831123393],
            [107.20499240274177, 30.929855049026738],
            [107.38007325602092, 30.942794450468945],
            [107.55520109115115, 30.95549785076639],
            [107.73037507847249, 30.967965068459744],
            [107.90559438571445, 30.98019592532436],
            [108.08085817803996, 30.992190246380456],
            [108.25616561808987, 31.003947859903253],
            [108.43151586602752, 31.01546859743276],
            [108.60690807958395, 31.026752293783623],
            [108.7823414141029, 31.0377987870545],
            [108.9578150225866, 31.0486079186376],
            [109.13332805574153, 31.059179533227734],
            [109.30887966202457, 31.069513478831404],
            [109.48446898768944, 31.079609606775563],
            [109.66009517683327, 31.089467771716325],
            [109.83575737144373, 31.099087831647413],
            [110.011454711446, 31.108469647908397],
            [110.18718633475038, 31.11761308519283],
            [110.36295137729994, 31.126518011556165],
            [110.53874897311843, 31.135184298423425],
            [110.7145782543585, 31.14361182059676],
            [110.89043835135004, 31.151800456262833],
            [111.06632839264884, 31.1597500869999],
            [111.24224750508553, 31.16746059778481],
            [111.4181948138144, 31.17493187699975],
            [111.5941694423629, 31.182163816438862],
            [111.77017051268102, 31.18915631131456],
            [111.94619714519094, 31.195909260263747],
            [112.1222484588369, 31.202422565353807],
            [112.29832357113521, 31.208696132088367],
            [112.47442159822452, 31.21472986941292],
            [112.65054165491617, 31.220523689720157],
            [112.82668285474469, 31.226077508855244],
            [113.00284431001862, 31.231391246120737],
            [113.17902513187131, 31.236464824281384],
            [113.35522443031194, 31.241298169568736],
            [113.53144131427662, 31.245891211685535],
            [113.70767489167979, 31.250243883809823],
            [113.88392426946552, 31.254356122599024],
            [114.0601885536591, 31.258227868193615],
            [114.23646684941869, 31.26185906422076],
            [114.41275826108706, 31.265249657797618],
            [114.58906189224348, 31.268399599534526],
            [114.76537684575561, 31.271308843537938],
            [114.94170222383167, 31.27397734741316],
            [115.11803712807243, 31.276405072266883],
            [115.2943806595235, 31.27859198270948],
            [115.47073191872758, 31.28053804685718],
            [115.64709000577683, 31.282243236333912],
            [115.82345402036526, 31.28370752627301],
            [115.99982306184107, 31.284930895318737],
            [116.17619622925929, 31.285913325627515],
            [116.35257262143426, 31.28665480286904],
            [116.52895133699217, 31.28715531622708],
            [116.70533147442355, 31.28741485840016],
            [116.8817121321361, 31.28743342560202],
            [117.0580924085071, 31.28721101756178],
            [117.23447140193603, 31.286747637524012],
            [117.41084821089731, 31.286043292248515],
            [117.58722193399282, 31.285097992009906],
            [117.76359167000443, 31.283911750597046],
            [117.93995651794664, 31.282484585312172],
            [118.11631557711907, 31.280816516969885],
            [118.29266794715906, 31.278907569895903],
            [118.46901272809394, 31.276757771925578],
            [118.64534902039362, 31.27436715440231],
            [118.82167592502275, 31.271735752175562],
            [118.99799254349321, 31.268863603598895],
            [119.17429797791613, 31.26575075052759],
            [119.35059133105422, 31.262397238316204],
            [119.52687170637368, 31.258803115815805],
            [119.70313820809623, 31.254968435371172],
            [119.87938994125103, 31.250893252817523],
            [120.05562601172639, 31.2465776274773],
            [120.2318455263214, 31.242021622156606],
            [120.40804759279759, 31.237225303141468],
            [120.58423131993031, 31.232188740193873],
            [120.76039581756008, 31.226912006547636],
            [120.93654019664363, 31.221395178904057],
            [121.11266356930511, 31.215638337427364],
            [121.28876504888679, 31.20964156573994],
            [121.46484375, 31.203404950917395]
        ]


        var line = new ol.Feature({
            geometry: new ol.geom.LineString(coordinates),
            dashOffset: 0
        });
        line.setStyle(new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: [25, 25, 255, 1],
                width: 6,
                lineDash: [2, 7],
            })
        }));


        layer.getSource().addFeature(line);
        map.addLayer(layer);





        //添加起点
        var route = new ol.geom.LineString(coordinates);
        var routeLength = coordinates.length;
        var routeFeature = new ol.Feature({
            type: 'route',
            geometry: route
        });
        var startMarker = new ol.Feature({
            geometry: new ol.geom.Point(coordinates[0])
        })
        startMarker.setStyle(new ol.style.Style({
            text: new ol.style.Text({
                font: '14px sans-serif',
                text: '起点',
                offsetY: -10
            })
        }))
        layer.getSource().addFeature(startMarker)
        //添加终点
        var endMarker = new ol.Feature({
            geometry: new ol.geom.Point(coordinates[coordinates.length - 1])
        })
        endMarker.setStyle(new ol.style.Style({
            text: new ol.style.Text({
                font: '14px sans-serif',
                text: '终点',
                offsetY: -10
            })
        }))
        layer.getSource().addFeature(endMarker)


        function getStyle() {
            var styles = {
                'route': new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        width: 4,
                        color: "red"
                    })
                }),
                'icon': new ol.style.Style({
                    image: new ol.style.Icon({
                        anchor: [0.5, 1],
                        scale: 0.3,
                        src: '../img/mo.png'
                    })
                }),
                'geoMarker': new ol.style.Style({
                    image: new ol.style.Icon({
                        anchor: [0.5, 0.5],
                        scale: 0.2,
                        src: '../img/mo.png'
                    })
                })
            };
            return styles
        }
        //添加小车，
        var geoMarker = new ol.Feature({
            geometry: new ol.geom.Point(coordinates[0])
        })
        geoMarker.setStyle(new ol.style.Style({
            image: new ol.style.Icon({
                src: '../img/mo.png'
            })
        }));

        var animating = false;
        var speed, now;
        var startButton = document.getElementById('start-animation');
        layer.getSource().addFeature(geoMarker)

        var vectorLayer = new ol.layer.Vector({
            source: new ol.source.Vector({
                features: [routeFeature, geoMarker, startMarker, endMarker]
            }),
            style: function(feature) {
                // hide geoMarker if animation is active
                if (animating && feature.get('type') === 'geoMarker') {
                    return null;
                }
                return styles[feature.get('type')];
            }
        });
        var speed = 1;
        // var animating = false;
        // var now;
        // var startButton = document.getElementById('start-animation');
        // $("#speed").on('change', function() {
        //     speed = $("#speed").val();
        // })

        var traversed = 0; //走过的路程
        // var elapsedTime = 0; //用过的时间
        // var retime = 0; //保存上次运动所用的时间
        var moveFeature = function(event) {
            //获取渲染图层的画布
            var vectorContext = event.vectorContext;

            var frameState = event.frameState;
            // if (animating) {
            // if (retime = 0) {
            elapsedTime = frameState.time - now;
            // } else {
            //     elapsedTime = frameState.time - retime;
            // }
            // retime = frameState.time;

            //计算路程
            var index = Math.round(speed * elapsedTime / 1000);

            traversed += index;
            //完成 ， 结束
            if (index >= routeLength) {
                stopAnimation(true);
                return;
            }
            // 设置车的位置
            geoMarker.getGeometry().setCoordinates(coordinates[traversed])
            // };
        }

        function startAnimation() {
            if (animating) {
                stopAnimation(false);
            } else {
                animating = true;
                now = new Date().getTime();
                // startButton.textContent = '取消';
                map.getView().setCenter(map.getView().getCenter());
                map.on('postcompose', moveFeature);
                map.render();
            }
        }

        //停止
        function stopAnimation(ended) {
            animating = false;
            // startButton.textContent = '开始';
            traversed = 0;
            // elapsedTime = 0;
            // retime = 0;
            // if animation cancelled set the marker at the beginning
            var coord = ended ? coordinates[routeLength - 1] : coordinates[0];
            /** @type {ol.geom.Point} */
            (geoMarker.getGeometry())
                .setCoordinates(coord);
            // remove listener
            map.un('postcompose', moveFeature);
        }

        startButton.addEventListener('click', startAnimation, false);

        map.on("click", function(e) {

            console.log(e.coordinate);
        })

        //定时器
        var time;
        $(".start").click(function() {
            var i = 0;
            clearInterval(time)
            var sportPoint = document.getElementById("sportPoint");
            time = setInterval(function() {
                i++;
                sportPoint.style.top = i + "px";
                if (i > $(".sport_line").height() - 40) {
                    clearInterval(time)
                }
            }, 2)
        });

        $("#stop").click(function() {
            var sportPoint = document.getElementById("sportPoint");
            sportPoint.style.top = -26 + "px";
            clearInterval(time)
            stopAnimation(false);
        })



    })
</script>
</body>
</html>
