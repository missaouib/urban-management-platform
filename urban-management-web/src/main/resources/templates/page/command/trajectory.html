<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>热线上报</title>
    <th:block th:include="page/fragments/common :: common_css"/>
    <th:block th:include="page/fragments/common :: fileUpload_css"/>
    <th:block th:include="page/fragments/common :: bootstrap_table_css"/>
    <th:block th:include="page/fragments/common :: bootstrap_datepicker_css"/>
    <th:block th:include="page/fragments/common :: swiper_css" />
    <link th:href="@{/css/comprehensiveEvaluation.css}" rel="stylesheet" type="text/css">
</head>

<body>
<div class="warp">
    <div class="linebox">
        <div class="line_box_rell">
            <div class="buttons">
                <div class="times">
                    <div class="titleone">轨迹回放:</div>
                    <div class="titleorther">2020/11/23</div>
                    <div class="titleorther">18:20</div>
                </div>
                <div class="controls">
                    <div class="start">
                        <div class="rameloss noneActive"></div>
                        <div class="animationStart" id="start-animation"></div>
                    </div>
                    <div class="stop" id="stop"></div>
                    <div class="write" id="wait"></div>
                </div>
                <div class="close">
                    <i class="closelogo"></i>
                </div>
            </div>
            <div class="sport">
                <div class="sport_line">
                    <div class="timestart">开始</div>
                    <div class="timeend">结束</div>

                    <div class="startPoint"></div>
                    <div class="endPoint"></div>
                    <div class="centerPoint"></div>


                    <div class="line_time">
                        <div class="contorl_times">
                            <div class="startTimes">8:00</div>
                            <div class="endTimes">18:00</div>
                            <div class="centerTimes">12:00</div>
                        </div>
                    </div>

                    <div class="sportPoint" id="sportPoint"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="map_box">

        <div class="map" id="map" style="width: 100%;height: 100%"></div>
<!--        <div class="follMap">-->

<!--        </div>-->
    </div>
</div>
</body>


</div>
<th:block th:include="page/fragments/common :: common_js"/>
<th:block th:include="page/fragments/common :: jquery_validation_js"/>
<th:block th:include="page/fragments/common :: fileUpload_js"/>
<th:block th:include="page/fragments/common :: map_js"/>
<th:block th:include="page/fragments/common :: bootstrap_table_js"/>
<th:block th:include="page/fragments/common :: bootstrap_datepicker_js"/>
<th:block th:include="page/fragments/common :: swiper_js"/>
<th:block th:include="page/fragments/common :: arc_js"/>
<script type="text/javascript" th:inline="javascript">
    $(function () {

        var projection = new ol.proj.Projection({
            code: 'EPSG:4326',
            units: 'degrees',
            axisOrientation: 'neu',
            global: true
        });



        var routeCoords = [
            [115.67817362455847, 41.66590597253936],
            [115.67818091681423, 41.665874288945375],
            [115.67819307057383, 41.66581108939546],
            [115.6782027935815, 41.665767252041874],
            [115.67820765508534, 41.66572588734972],
            [115.67821008583726, 41.665677104673264],
            [115.67821737809302, 41.66564060148495],
            [115.67822467034878, 41.66557953932035],
            [115.67823682410838, 41.66555037029731],
            [115.67824411636414, 41.66551629786092],
            [115.67824654711606, 41.66546768282252],
            [115.6782514086199, 41.66543608304757],
            [115.67826842388334, 41.6653677286272],
            [115.67826842388334, 41.6653048224439],
            [115.6782659512219, 41.66527070809799],
            [115.67825606057616, 41.66520738281953],
            [115.67826088017048, 41.66512737755376],
            [115.67826574167432, 41.66507364955443],
            [115.67827060317816, 41.66502733953941],
            [115.67827789543392, 41.66494452633607],
            [115.67828275693776, 41.66490056325394],
            [115.6782876184416, 41.66485429514843],
            [115.67829491069736, 41.66481293045628],
            [115.67829734144928, 41.66476909310269],
            [115.67828745080354, 41.66471041978049],
            [115.6782947430593, 41.66466163710403],
            [115.67829717381122, 41.664607992923735],
            [115.67830932757082, 41.66455904260921],
            [115.6783190505785, 41.664495675421236],
            [115.67832634283425, 41.664441863602875],
            [115.67834335809769, 41.66438566294211],
            [115.67835065035345, 41.66434186749804],
            [115.67835308110537, 41.66427363880622],
            [115.67836234310838, 41.66420235071975],
            [115.67837516742023, 41.664132361828266],
            [115.67837269475879, 41.664088566384194],
            [115.67837269475879, 41.66406182811308],
            [115.67837269475879, 41.66402033769238],
            [115.67837269475879, 41.663969124264],
            [115.67837269475879, 41.66393019032377],
            [115.67837269475879, 41.663874073482035],
            [115.67837269475879, 41.66385219671476],
            [115.67838484851839, 41.66378891334581],
            [115.67838727927031, 41.66373288032311],
            [115.67838727927031, 41.663691557540474],
            [115.67838971002223, 41.66364767827737],
            [115.67839214077415, 41.66359893751043],
            [115.67839943302991, 41.663540306097744],
            [115.67839448770704, 41.663448230891404],
            [115.67839691845896, 41.66340686619925],
            [115.67841150297048, 41.663360514274714],
            [115.67841787321689, 41.6632550280233],
            [115.67849171778383, 41.663043636425314],
            [115.67853132227631, 41.662951351671396],
            [115.67855076829167, 41.66289033141631],
            [115.67864426842155, 41.66289033141631],
            [115.67870931199016, 41.66289841995287],
            [115.6787691587788, 41.66289841995287],
            [115.67883030476244, 41.66289841995287],
            [115.67889304330768, 41.6629114538123],
            [115.679023381902, 41.66292327229577],
            [115.6791008306873, 41.66293877881664],
            [115.6791565703434, 41.66293877881664],
            [115.67922203300716, 41.66293877881664],
            [115.6792683849317, 41.662938820726154],
            [115.6793048462105, 41.662936389974234],
            [115.67933891864689, 41.662933959222315],
            [115.6793730329928, 41.662933959222315],
            [115.67945119423987, 41.662933959222315],
            [115.67949478013637, 41.66294137720662],
            [115.67954125778945, 41.66293651570278],
            [115.67958769353302, 41.66293898836422],
            [115.67968685144754, 41.66294460423934],
            [115.67976182757141, 41.66294460423934],
            [115.67980985587658, 41.66294460423934],
            [115.67983511065857, 41.6629495164728],
            [115.67992516787572, 41.66294829919976],
            [115.6800221509567, 41.66294586465369],
            [115.68014499059593, 41.66293507709611],
            [115.68023269721688, 41.6629301240541],
            [115.68039423774366, 41.66293048084103],
            [115.68043071395978, 41.66293419562253],
            [115.68051243915288, 41.66293299933696],
            [115.68053563030296, 41.66293299933696],
            [115.6806287936651, 41.662927164821376]
        ]

        var routeLength = routeCoords.length;

        var routeFeature = new ol.Feature({
            type: 'route',
            geometry: new ol.geom.LineString(routeCoords)
        });
        var geoMarker = new ol.Feature({
            type: 'geoMarker',
            geometry: new ol.geom.Point(routeCoords[0])
        });

        var styles = {
            'route': new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: [25, 25, 255, 1],
                    width: 6,
                    lineDash: [2, 7],
                })
            }),
            'geoMarker': new ol.style.Style({
                image: new ol.style.Icon({
                    src: '../img/taxi.png',
                    rotateWithView: false,
                    rotation: -Math.atan2(routeCoords[1][1] - routeCoords[0][1], routeCoords[1][0] - routeCoords[0][0])
                })
            })
        };

        var animating = false;
        var now;
        var progress = 0;

        var vectorLayer = new ol.layer.Vector({
            source: new ol.source.Vector({
                features: [routeFeature, geoMarker]
            }),
            style: function(feature) {
                if (animating && feature.get('type') === 'geoMarker') {
                    return null;
                }
                return styles[feature.get('type')];
            }
        });
        var vectorLayer2 = new ol.layer.Vector({
            source: new ol.source.Vector({})
        });

        var map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Image({
                    source: new ol.source.ImageWMS({
                        ratio: 1,
                        url: 'http://192.168.24.203:7880/geoserver/guyuan20201010/wms',
                        params: {
                            'VERSION': '1.1.1',
                            "LAYERS": 'guyuan20201010:guyuan',
                            "exceptions": 'application/vnd.ogc.se_inimage',
                        }
                    }),
                    projection: 'EPSG:4326',
                }), vectorLayer, vectorLayer2
            ],
            view: new ol.View({
                projection: projection,
                center: [115.68192, 41.66462],
                zoom: 17
            })
        });

        var startMarker = new ol.Feature({
            geometry: new ol.geom.Point(routeCoords[0])
        })
        startMarker.setStyle(new ol.style.Style({
            text: new ol.style.Text({
                font: '16px sans-serif',
                text: '起点',
                offsetY: -10,
                fill: new ol.style.Fill({
                    color: '#f58220'
                }),
                stroke: new ol.style.Stroke({
                    color: '#fff',
                    width: 3
                })
            }),
        }))
        vectorLayer.getSource().addFeature(startMarker)
        //添加终点
        var endMarker = new ol.Feature({
            geometry: new ol.geom.Point(routeCoords[routeCoords.length - 1])
        })
        endMarker.setStyle(new ol.style.Style({
            text: new ol.style.Text({
                font: '14px sans-serif',
                text: '终点',
                offsetY: -10,
                fill: new ol.style.Fill({
                    color: '#f58220'
                }),
                stroke: new ol.style.Stroke({
                    color: '#fff',
                    width: 3
                })
            })
        }))
        vectorLayer.getSource().addFeature(endMarker)

        var helpTooltipElement = document.createElement('div');
        helpTooltipElement.className = 'measuretip';
        var helpTooltip = new ol.Overlay({
            element: helpTooltipElement,
            offset: [15, 0],
            positioning: 'center-left'
        });
        map.addOverlay(helpTooltip);

        window.requestAnimationFrame = window.requestAnimationFrame || window.taxizRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
        var cancelAnimationFrame = window.cancelAnimationFrame || window.taxizCancelAnimationFrame;

        var progress = 0;
        var animation;
        var taxiveFeature = function(timestamp) {
            var speed = 1;
            // var speed = document.getElementById("speed").value;
            progress += 1;
            if (progress % speed == 0) {
                var currentPoint = new ol.geom.Point(routeCoords[progress / speed]);
                var dx = routeCoords[progress / speed][0] - routeCoords[progress / speed - 1][0];
                var dy = routeCoords[progress / speed][1] - routeCoords[progress / speed - 1][1];
                var rotation = Math.atan2(dy, dx);
                var styleGeomarker = new ol.style.Style({
                    image: new ol.style.Icon({
                        src: '../img/taxi.png',
                        rotateWithView: false,
                        rotation: -rotation
                    })
                })
                var feature = new ol.Feature(currentPoint);
                vectorLayer2.getSource().clear();
                vectorLayer2.getSource().addFeature(feature);
                vectorLayer2.setStyle(styleGeomarker);
            }
            if (progress % speed != 0) {
                var arcGenerator = new arc.GreatCircle({
                    x: routeCoords[Math.floor(progress / speed)][0],
                    y: routeCoords[Math.floor(progress / speed)][1]
                }, {
                    x: routeCoords[Math.floor(progress / speed + 1)][0],
                    y: routeCoords[Math.floor(progress / speed + 1)][1]
                });

                var arcLine = arcGenerator.Arc(speed, {
                    offset: 0
                }); //在两个点之间生成100个点

                var line = new ol.geom.LineString(arcLine.geometries[0].coords);
                var lineFeature = new ol.Feature({
                    type: 'route',
                    geometry: line
                });


                var currentPoint = new ol.geom.Point(arcLine.geometries[0].coords[progress % speed]);
                var dx = arcLine.geometries[0].coords[progress % speed][0] - arcLine.geometries[0].coords[progress % speed - 1][0];
                var dy = arcLine.geometries[0].coords[progress % speed][1] - arcLine.geometries[0].coords[progress % speed - 1][1];
                var rotation = Math.atan2(dy, dx);
                var styleGeomarker = new ol.style.Style({
                    image: new ol.style.Icon({
                        src: '../img/taxi.png',
                        rotateWithView: false,
                        rotation: -rotation
                    })
                })
                var feature = new ol.Feature(currentPoint);
                vectorLayer2.getSource().clear();
                vectorLayer2.getSource().addFeature(feature);
                vectorLayer2.setStyle(styleGeomarker);
                // helpTooltipElement.innerHTML = "<B>名称：</B>出租车" + "\<br\>" +
                //     "<B>当前速度：</B>75km/h" + "\<br\>" +
                //     "<B>号牌：</B>浙A0001" + "\<br\>" +
                //     "<B>经纬度：</B>" + (arcLine.geometries[0].coords[progress % 2][0] + "").substring(0, 8) + "," + (arcLine.geometries[0].coords[progress % 2][1] + "").substring(0, 7);
                // helpTooltip.setPosition(arcLine.geometries[0].coords[progress % 2]);
            }
            if (progress / speed < routeLength - 1) {
                animation = requestAnimationFrame(taxiveFeature);
            }

        }

        // document.getElementById("pauseButton").disabled = true;

        function startAnimation() {
            if (animating) {
                //stopAnimation(false);
                //stopAnimation2();
            } else {
                animating = true;
                geoMarker.setStyle(null);
                animation = requestAnimationFrame(taxiveFeature);
                map.render();
                // document.getElementById("startButton").value = "停止回放";
                // document.getElementById("startButton").onclick = stopAnimation
                // document.getElementById("pauseButton").disabled = false;
            }
        }


        function stopAnimation() {
            window.cancelAnimationFrame(animation);
            vectorLayer2.getSource().clear();
            helpTooltip.setPosition(undefined);
            geoMarker.setStyle(styles.geoMarker);
            progress = 0;
            animating = false;
            // document.getElementById("startButton").value = "开始回放";
            // document.getElementById("startButton").onclick = startAnimation
            // document.getElementById("pauseButton").value = "暂停";
            // document.getElementById("pauseButton").onclick = pauseAnimation
            // document.getElementById("pauseButton").disabled = true;
        }

        function pauseAnimation() {
            window.cancelAnimationFrame(animation);
            // document.getElementById("pauseButton").value = "继续";
            // document.getElementById("pauseButton").onclick = continueAnimation
        }

        function continueAnimation() {
            animation = requestAnimationFrame(taxiveFeature);
            // document.getElementById("pauseButton").value = "暂停";
            document.getElementById("pauseButton").onclick = pauseAnimation
        }

        //定时器
        var time;
        $("#start-animation").click(function() {
            $(".rameloss").removeClass("noneActive")
            var i = 0;
            clearInterval(time)
            var sportPoint = document.getElementById("sportPoint");
            time = setInterval(function() {
                i++;
                sportPoint.style.top = i + "px";
                if (i > $(".sport_line").height() - 40) {
                    clearInterval(time)
                }
            }, 2)
            startAnimation()
        });

        $("#stop").click(function() {
            $(".rameloss").addClass("noneActive")
            var sportPoint = document.getElementById("sportPoint");
            sportPoint.style.top = -26 + "px";
            clearInterval(time)
            stopAnimation()
        })

    })
</script>
</body>
</html>
