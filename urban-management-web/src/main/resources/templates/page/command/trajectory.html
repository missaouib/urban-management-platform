<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>热线上报</title>
    <th:block th:include="page/fragments/common :: common_css"/>
    <th:block th:include="page/fragments/common :: fileUpload_css"/>
    <th:block th:include="page/fragments/common :: bootstrap_table_css"/>
    <th:block th:include="page/fragments/common :: bootstrap_datepicker_css"/>
    <th:block th:include="page/fragments/common :: swiper_css" />
    <link th:href="@{/css/comprehensiveEvaluation.css}" rel="stylesheet" type="text/css">
</head>

<body>
<div class="warp">
    <div class="linebox">
        <div class="line_box_rell">
            <div class="buttons">
                <div class="times">
                    <div class="titleone">轨迹回放:</div>
                    <div class="titleorther">2020/11/23</div>
                    <div class="titleorther">18:20</div>
                </div>
                <div class="controls">
                    <div class="start" id="start-animation"></div>
                    <div class="stop" id="stop"></div>
                    <div class="write" id="wait"></div>
                </div>
                <div class="close">
                    <i class="closelogo"></i>
                </div>
            </div>
            <div class="sport">
                <div class="sport_line">
                    <div class="timestart">开始</div>
                    <div class="timeend">结束</div>

                    <div class="startPoint"></div>
                    <div class="endPoint"></div>
                    <div class="centerPoint"></div>


                    <div class="line_time">
                        <div class="contorl_times">
                            <div class="startTimes">8:00</div>
                            <div class="endTimes">18:00</div>
                            <div class="centerTimes">12:00</div>
                        </div>
                    </div>

                    <div class="sportPoint" id="sportPoint"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="map_box">

        <div class="map" id="map" style="width: 100%;height: 100%"></div>
<!--        <div class="follMap">-->

<!--        </div>-->
    </div>
</div>
</body>


</div>
<th:block th:include="page/fragments/common :: common_js"/>
<th:block th:include="page/fragments/common :: jquery_validation_js"/>
<th:block th:include="page/fragments/common :: fileUpload_js"/>
<th:block th:include="page/fragments/common :: map_js"/>
<th:block th:include="page/fragments/common :: bootstrap_table_js"/>
<th:block th:include="page/fragments/common :: bootstrap_datepicker_js"/>
<th:block th:include="page/fragments/common :: swiper_js"/>
<script type="text/javascript" th:inline="javascript">
    $(function () {

        var center = [115.68192, 41.66462];
        var projection = new ol.proj.Projection({
            code: 'EPSG:4326',
            units: 'degrees',
            axisOrientation: 'neu',
            global: true
        });
        var untiled = new ol.layer.Image({
            source: new ol.source.ImageWMS({
                ratio: 1,
                url: 'http://192.168.24.203:7880/geoserver/guyuan20201010/wms',
                params: {
                    'VERSION': '1.1.1',
                    "LAYERS": 'guyuan20201010:guyuan',
                    "exceptions": 'application/vnd.ogc.se_inimage',
                }
            })
        });
        var source = new ol.source.Vector({wrapX: false});

        var map = new ol.Map({
            target: 'map',
            layers: [
                untiled
            ],
            view: new ol.View({
                center: center,
                zoom: 17,
                projection: projection
            })
        });

        var layer = new ol.layer.Vector({
            source: new ol.source.Vector(),
        });
        var coordinates = [
            [115.67814772447767, 41.666144332910775],
            [115.67814772447767, 41.66609751998156],
            [115.67814772447767, 41.66609751998156],
            [115.6781649911982, 41.665977176806805],
            [115.67817362455847, 41.66590597253936],
            [115.67818091681423, 41.665874288945375],
            [115.67819307057383, 41.66581108939546],
            [115.6782027935815, 41.665767252041874],
            [115.67820765508534, 41.66572588734972],
            [115.67821008583726, 41.665677104673264],
            [115.67821737809302, 41.66564060148495],
            [115.67822467034878, 41.66557953932035],
            [115.67823682410838, 41.66555037029731],
            [115.67824411636414, 41.66551629786092],
            [115.67824654711606, 41.66546768282252],
            [115.6782514086199, 41.66543608304757],
            [115.67826842388334, 41.6653677286272],
            [115.67826842388334, 41.6653048224439],
            [115.6782659512219, 41.66527070809799],
            [115.67825606057616, 41.66520738281953],
            [115.67826088017048, 41.66512737755376],
            [115.67826574167432, 41.66507364955443],
            [115.67827060317816, 41.66502733953941],
            [115.67827789543392, 41.66494452633607],
            [115.67828275693776, 41.66490056325394],
            [115.6782876184416, 41.66485429514843],
            [115.67829491069736, 41.66481293045628],
            [115.67829734144928, 41.66476909310269],
            [115.67828745080354, 41.66471041978049],
            [115.6782947430593, 41.66466163710403],
            [115.67829717381122, 41.664607992923735],
            [115.67830932757082, 41.66455904260921],
            [115.6783190505785, 41.664495675421236],
            [115.67832634283425, 41.664441863602875],
            [115.67834335809769, 41.66438566294211],
            [115.67835065035345, 41.66434186749804],
            [115.67835308110537, 41.66427363880622],
            [115.67836234310838, 41.66420235071975],
            [115.67837516742023, 41.664132361828266],
            [115.67837269475879, 41.664088566384194],
            [115.67837269475879, 41.66406182811308],
            [115.67837269475879, 41.66402033769238],
            [115.67837269475879, 41.663969124264],
            [115.67837269475879, 41.66393019032377],
            [115.67837269475879, 41.663874073482035],
            [115.67837269475879, 41.66385219671476],
            [115.67838484851839, 41.66378891334581],
            [115.67838727927031, 41.66373288032311],
            [115.67838727927031, 41.663691557540474],
            [115.67838971002223, 41.66364767827737],
            [115.67839214077415, 41.66359893751043],
            [115.67839943302991, 41.663540306097744],
            [115.67839448770704, 41.663448230891404],
            [115.67839691845896, 41.66340686619925],
            [115.67841150297048, 41.663360514274714],
            [115.67841787321689, 41.6632550280233],
            [115.67849171778383, 41.663043636425314],
            [115.67853132227631, 41.662951351671396],
            [115.67855076829167, 41.66289033141631],
            [115.67864426842155, 41.66289033141631],
            [115.67870931199016, 41.66289841995287],
            [115.6787691587788, 41.66289841995287],
            [115.67883030476244, 41.66289841995287],
            [115.67889304330768, 41.6629114538123],
            [115.679023381902, 41.66292327229577],
            [115.6791008306873, 41.66293877881664],
            [115.6791565703434, 41.66293877881664],
            [115.67922203300716, 41.66293877881664],
            [115.6792683849317, 41.662938820726154],
            [115.6793048462105, 41.662936389974234],
            [115.67933891864689, 41.662933959222315],
            [115.6793730329928, 41.662933959222315],
            [115.67945119423987, 41.662933959222315],
            [115.67949478013637, 41.66294137720662],
            [115.67954125778945, 41.66293651570278],
            [115.67958769353302, 41.66293898836422],
            [115.67968685144754, 41.66294460423934],
            [115.67976182757141, 41.66294460423934],
            [115.67980985587658, 41.66294460423934],
            [115.67983511065857, 41.6629495164728],
            [115.67992516787572, 41.66294829919976],
            [115.6800221509567, 41.66294586465369],
            [115.68014499059593, 41.66293507709611],
            [115.68023269721688, 41.6629301240541],
            [115.68039423774366, 41.66293048084103],
            [115.68043071395978, 41.66293419562253],
            [115.68051243915288, 41.66293299933696],
            [115.68053563030296, 41.66293299933696],
            [115.6806287936651, 41.662927164821376]
        ]


        var line = new ol.Feature({
            geometry: new ol.geom.LineString(coordinates),
            dashOffset: 0
        });
        line.setStyle(new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: [25, 25, 255, 1],
                width: 6,
                lineDash: [2, 7],
            })
        }));


        layer.getSource().addFeature(line);
        map.addLayer(layer);





        //添加起点
        var route = new ol.geom.LineString(coordinates);
        var routeLength = coordinates.length;
        var routeFeature = new ol.Feature({
            type: 'route',
            geometry: route
        });
        var startMarker = new ol.Feature({
            geometry: new ol.geom.Point(coordinates[0])
        })
        startMarker.setStyle(new ol.style.Style({
            text: new ol.style.Text({
                font: '16px sans-serif',
                text: '起点',
                offsetY: -10,
                fill: new ol.style.Fill({
                    color: '#f58220'
                }),
                stroke: new ol.style.Stroke({
                    color: '#fff',
                    width: 3
                })
            }),
        }))
        layer.getSource().addFeature(startMarker)
        //添加终点
        var endMarker = new ol.Feature({
            geometry: new ol.geom.Point(coordinates[coordinates.length - 1])
        })
        endMarker.setStyle(new ol.style.Style({
            text: new ol.style.Text({
                font: '14px sans-serif',
                text: '终点',
                offsetY: -10,
                fill: new ol.style.Fill({
                    color: '#f58220'
                }),
                stroke: new ol.style.Stroke({
                    color: '#fff',
                    width: 3
                })
            })
        }))
        layer.getSource().addFeature(endMarker)


        function getStyle() {
            var styles = {
                'route': new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        width: 4,
                        color: "red"
                    })
                }),
                'icon': new ol.style.Style({
                    image: new ol.style.Icon({
                        anchor: [0.5, 1],
                        scale: 0.3,
                        src: '../img/mo.png'
                    })
                }),
                'geoMarker': new ol.style.Style({
                    image: new ol.style.Icon({
                        anchor: [0.5, 0.5],
                        scale: 0.2,
                        src: '../img/mo.png'
                    })
                })
            };
            return styles
        }
        //添加小车，
        var geoMarker = new ol.Feature({
            geometry: new ol.geom.Point(coordinates[0])
        })
        geoMarker.setStyle(new ol.style.Style({
            image: new ol.style.Icon({
                src: '../img/mo.png'
            })
        }));

        var animating = false;
        var speed, now;
        var startButton = document.getElementById('start-animation');
        layer.getSource().addFeature(geoMarker)

        var vectorLayer = new ol.layer.Vector({
            source: new ol.source.Vector({
                features: [routeFeature, geoMarker, startMarker, endMarker]
            }),
            style: function(feature) {
                // hide geoMarker if animation is active
                if (animating && feature.get('type') === 'geoMarker') {
                    return null;
                }
                return styles[feature.get('type')];
            }
        });
        var speed = 1;
        // var animating = false;
        // var now;
        // var startButton = document.getElementById('start-animation');
        // $("#speed").on('change', function() {
        //     speed = $("#speed").val();
        // })

        var traversed = 0; //走过的路程
        // var elapsedTime = 0; //用过的时间
        // var retime = 0; //保存上次运动所用的时间
        var moveFeature = function(event) {
            //获取渲染图层的画布
            var vectorContext = event.vectorContext;

            var frameState = event.frameState;
            // if (animating) {
            // if (retime = 0) {
            elapsedTime = frameState.time - now;
            // } else {
            //     elapsedTime = frameState.time - retime;
            // }
            // retime = frameState.time;

            //计算路程
            var index = Math.round(speed * elapsedTime / 1000);

            traversed += index;
            //完成 ， 结束
            if (index >= routeLength) {
                stopAnimation(true);
                return;
            }
            // 设置车的位置
            geoMarker.getGeometry().setCoordinates(coordinates[traversed])
            // };
        }

        function startAnimation() {
            if (animating) {
                stopAnimation(false);
            } else {
                animating = true;
                now = new Date().getTime();
                // startButton.textContent = '取消';
                map.getView().setCenter(map.getView().getCenter());
                map.on('postcompose', moveFeature);
                map.render();
            }
        }

        //停止
        function stopAnimation(ended) {
            animating = false;
            // startButton.textContent = '开始';
            traversed = 0;
            // elapsedTime = 0;
            // retime = 0;
            // if animation cancelled set the marker at the beginning
            var coord = ended ? coordinates[routeLength - 1] : coordinates[0];
            /** @type {ol.geom.Point} */
            (geoMarker.getGeometry())
                .setCoordinates(coord);
            // remove listener
            map.un('postcompose', moveFeature);
        }

        startButton.addEventListener('click', startAnimation, false);

        map.on("click", function(e) {
            console.log(e.coordinate);
        })

        //定时器
        var time;
        $(".start").click(function() {
            var i = 0;
            clearInterval(time)
            var sportPoint = document.getElementById("sportPoint");
            time = setInterval(function() {
                i++;
                sportPoint.style.top = i + "px";
                if (i > $(".sport_line").height() - 40) {
                    clearInterval(time)
                }
            }, 2)
        });

        $("#stop").click(function() {
            var sportPoint = document.getElementById("sportPoint");
            sportPoint.style.top = -26 + "px";
            clearInterval(time)
            stopAnimation(false);
        })



    })
</script>
</body>
</html>
