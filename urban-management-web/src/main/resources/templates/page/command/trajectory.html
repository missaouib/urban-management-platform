<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>热线上报</title>
    <th:block th:include="page/fragments/common :: common_css"/>
    <th:block th:include="page/fragments/common :: fileUpload_css"/>
    <th:block th:include="page/fragments/common :: bootstrap_table_css"/>
    <th:block th:include="page/fragments/common :: bootstrap_datepicker_css"/>
    <th:block th:include="page/fragments/common :: swiper_css" />
    <link th:href="@{/css/comprehensiveEvaluation.css}" rel="stylesheet" type="text/css">
</head>

<body>
<div class="warp">
    <div class="linebox">
        <div class="line_box_rell">
            <div class="buttons">
                <div class="times">
                    <div class="titleone">轨迹回放:</div>
                    <div class="titleorther">2020/11/23</div>
                    <div class="titleorther">18:20</div>
                </div>
                <div class="controls">
                    <div class="start">
                        <div class="rameloss noneActive"></div>
                        <div class="animationStart" id="start-animation"></div>
                    </div>
                    <div class="stop" id="stop"></div>
                    <div class="write" id="wait"></div>
                </div>
                <div class="close">
                    <i class="closelogo"></i>
                </div>
            </div>
            <div class="sport">
                <div class="sport_line">
                    <div class="timestart">开始</div>
                    <div class="timeend">结束</div>

                    <div class="startPoint"></div>
                    <div class="endPoint"></div>
                    <div class="centerPoint"></div>


                    <div class="line_time">
                        <div class="contorl_times">
                            <div class="startTimes">8:00</div>
                            <div class="endTimes">18:00</div>
                            <div class="centerTimes">12:00</div>
                        </div>
                    </div>

                    <div class="sportPoint" id="sportPoint"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="map_box">

        <div class="map" id="map" style="width: 100%;height: 100%"></div>
<!--        <div class="follMap">-->

<!--        </div>-->
    </div>
</div>
</body>


</div>
<th:block th:include="page/fragments/common :: common_js"/>
<th:block th:include="page/fragments/common :: jquery_validation_js"/>
<th:block th:include="page/fragments/common :: fileUpload_js"/>
<th:block th:include="page/fragments/common :: map_js"/>
<th:block th:include="page/fragments/common :: bootstrap_table_js"/>
<th:block th:include="page/fragments/common :: bootstrap_datepicker_js"/>
<th:block th:include="page/fragments/common :: swiper_js"/>
<th:block th:include="page/fragments/common :: arc_js"/>
<script type="text/javascript" th:inline="javascript">
    $(function () {

        var projection = new ol.proj.Projection({
            code: 'EPSG:4326',
            units: 'degrees',
            axisOrientation: 'neu',
            global: true
        });



        var routeCoords = [
            [596128.6186523438, 5244926.363037108],
            [596109.0764160156, 5244731.730651855],
            [596137.3122558594, 5244630.6497802725],
            [596118.1118164062, 5244417.368957519],
            [596143.7124023438, 5244314.96533203],
            [596124.5119628906, 5244231.762573241],
            [595768.142578125, 5244211.22314453],
            [595691.3391113281, 5244201.622924804],
            [595708.21875, 5244004.906860351],
            [595717.8181152344, 5243966.505126952],
            [595735.576171875, 5243862.593322753],
            [595729.1760253906, 5243692.23876953],
            [595714.330078125, 5243439.661987304],
            [595699.7729492188, 5243293.03540039],
            [595683.7717285156, 5243197.031921386],
            [595716.6508789062, 5243107.99255371],
            [596022.2736816406, 5243081.698974608],
            [595987.0737304688, 5242988.895996093],
            [595847.3950195312, 5242949.616699218],
            [595751.3928222656, 5242892.015380858],
            [595647.7958984375, 5242775.617309569],
            [595641.3940429688, 5242661.5413208],
            [595641.3940429688, 5242607.1392211905],
            [595647.7958984375, 5242511.699279784],
            [595647.7958984375, 5242396.494079589],
            [595586.4040527344, 5242347.07067871],
            [595600.962890625, 5242237.323120116],
            [595631.51953125, 5242127.011596679]
        ]

        var routeLength = routeCoords.length;

        var routeFeature = new ol.Feature({
            type: 'route',
            geometry: new ol.geom.LineString(routeCoords)
        });
        var geoMarker = new ol.Feature({
            type: 'geoMarker',
            geometry: new ol.geom.Point(routeCoords[0])
        });

        var styles = {
            'route': new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: [25, 25, 255, 1],
                    width: 6,
                    lineDash: [2, 7],
                })
            }),
            'geoMarker': new ol.style.Style({
                image: new ol.style.Icon({
                    src: '../img/taxi.png',
                    rotateWithView: false,
                    rotation: -Math.atan2(routeCoords[1][1] - routeCoords[0][1], routeCoords[1][0] - routeCoords[0][0])
                })
            })
        };

        var animating = false;
        var now;
        var progress = 0;

        var vectorLayer = new ol.layer.Vector({
            source: new ol.source.Vector({
                features: [routeFeature, geoMarker]
            }),
            style: function(feature) {
                if (animating && feature.get('type') === 'geoMarker') {
                    return null;
                }
                return styles[feature.get('type')];
            }
        });
        var vectorLayer2 = new ol.layer.Vector({
            source: new ol.source.Vector({})
        });



        var startMarker = new ol.Feature({
            geometry: new ol.geom.Point(routeCoords[0])
        })
        startMarker.setStyle(new ol.style.Style({
            text: new ol.style.Text({
                font: '16px sans-serif',
                text: '起点',
                offsetY: -10,
                fill: new ol.style.Fill({
                    color: '#f58220'
                }),
                stroke: new ol.style.Stroke({
                    color: '#fff',
                    width: 3
                })
            }),
        }))
        vectorLayer.getSource().addFeature(startMarker)
        //添加终点
        var endMarker = new ol.Feature({
            geometry: new ol.geom.Point(routeCoords[routeCoords.length - 1])
        })
        endMarker.setStyle(new ol.style.Style({
            text: new ol.style.Text({
                font: '14px sans-serif',
                text: '终点',
                offsetY: -10,
                fill: new ol.style.Fill({
                    color: '#f58220'
                }),
                stroke: new ol.style.Stroke({
                    color: '#fff',
                    width: 3
                })
            })
        }))
        vectorLayer.getSource().addFeature(endMarker)

        var helpTooltipElement = document.createElement('div');
        helpTooltipElement.className = 'measuretip';
        var helpTooltip = new ol.Overlay({
            element: helpTooltipElement,
            offset: [15, 0],
            positioning: 'center-left'
        });
        map.addOverlay(helpTooltip);

        window.requestAnimationFrame = window.requestAnimationFrame || window.taxizRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
        var cancelAnimationFrame = window.cancelAnimationFrame || window.taxizCancelAnimationFrame;

        var progress = 0;
        var animation;
        var taxiveFeature = function(timestamp) {
            var speed = 2;
            // var speed = document.getElementById("speed").value;
            progress += 1;
            if (progress % speed == 0) {
                var currentPoint = new ol.geom.Point(routeCoords[progress / speed]);
                var dx = routeCoords[progress / speed][0] - routeCoords[progress / speed - 1][0];
                var dy = routeCoords[progress / speed][1] - routeCoords[progress / speed - 1][1];
                var rotation = Math.atan2(dy, dx);
                var styleGeomarker = new ol.style.Style({
                    image: new ol.style.Icon({
                        src: '../img/taxi.png',
                        rotateWithView: false,
                        rotation: -rotation
                    })
                })
                var feature = new ol.Feature(currentPoint);
                vectorLayer2.getSource().clear();
                vectorLayer2.getSource().addFeature(feature);
                vectorLayer2.setStyle(styleGeomarker);
            }
            if (progress % speed != 0) {
                var arcGenerator = new arc.GreatCircle({
                    x: routeCoords[Math.floor(progress / speed)][0],
                    y: routeCoords[Math.floor(progress / speed)][1]
                }, {
                    x: routeCoords[Math.floor(progress / speed + 1)][0],
                    y: routeCoords[Math.floor(progress / speed + 1)][1]
                });

                var arcLine = arcGenerator.Arc(speed, {
                    offset: 0
                }); //在两个点之间生成100个点

                var line = new ol.geom.LineString(arcLine.geometries[0].coords);
                var lineFeature = new ol.Feature({
                    type: 'route',
                    geometry: line
                });


                var currentPoint = new ol.geom.Point(arcLine.geometries[0].coords[progress % speed]);
                var dx = arcLine.geometries[0].coords[progress % speed][0] - arcLine.geometries[0].coords[progress % speed - 1][0];
                var dy = arcLine.geometries[0].coords[progress % speed][1] - arcLine.geometries[0].coords[progress % speed - 1][1];
                var rotation = Math.atan2(dy, dx);
                var styleGeomarker = new ol.style.Style({
                    image: new ol.style.Icon({
                        src: '../img/taxi.png',
                        rotateWithView: false,
                        rotation: -rotation
                    })
                })
                var feature = new ol.Feature(currentPoint);
                vectorLayer2.getSource().clear();
                vectorLayer2.getSource().addFeature(feature);
                vectorLayer2.setStyle(styleGeomarker);
                // helpTooltipElement.innerHTML = "<B>名称：</B>出租车" + "\<br\>" +
                //     "<B>当前速度：</B>75km/h" + "\<br\>" +
                //     "<B>号牌：</B>浙A0001" + "\<br\>" +
                //     "<B>经纬度：</B>" + (arcLine.geometries[0].coords[progress % 2][0] + "").substring(0, 8) + "," + (arcLine.geometries[0].coords[progress % 2][1] + "").substring(0, 7);
                // helpTooltip.setPosition(arcLine.geometries[0].coords[progress % 2]);
            }
            if (progress / speed < routeLength - 1) {
                animation = requestAnimationFrame(taxiveFeature);
            }

        }

        // document.getElementById("pauseButton").disabled = true;

        function startAnimation() {
            if (animating) {
                //stopAnimation(false);
                //stopAnimation2();
            } else {
                animating = true;
                geoMarker.setStyle(null);
                animation = requestAnimationFrame(taxiveFeature);
                map.render();
                // document.getElementById("startButton").value = "停止回放";
                // document.getElementById("startButton").onclick = stopAnimation
                // document.getElementById("pauseButton").disabled = false;
            }
        }


        function stopAnimation() {
            window.cancelAnimationFrame(animation);
            vectorLayer2.getSource().clear();
            helpTooltip.setPosition(undefined);
            geoMarker.setStyle(styles.geoMarker);
            progress = 0;
            animating = false;
            // document.getElementById("startButton").value = "开始回放";
            // document.getElementById("startButton").onclick = startAnimation
            // document.getElementById("pauseButton").value = "暂停";
            // document.getElementById("pauseButton").onclick = pauseAnimation
            // document.getElementById("pauseButton").disabled = true;
        }

        function pauseAnimation() {
            window.cancelAnimationFrame(animation);
            // document.getElementById("pauseButton").value = "继续";
            // document.getElementById("pauseButton").onclick = continueAnimation
        }

        function continueAnimation() {
            animation = requestAnimationFrame(taxiveFeature);
            // document.getElementById("pauseButton").value = "暂停";
            document.getElementById("pauseButton").onclick = pauseAnimation
        }

        //定时器
        var time;
        $("#start-animation").click(function() {
            $(".rameloss").removeClass("noneActive")
            var i = 0;
            clearInterval(time)
            var sportPoint = document.getElementById("sportPoint");
            time = setInterval(function() {
                i++;
                sportPoint.style.top = i + "px";
                if (i > $(".sport_line").height() - 40) {
                    clearInterval(time)
                }
            }, 3)
            startAnimation()
        });

        $("#stop").click(function() {
            $(".rameloss").addClass("noneActive")
            var sportPoint = document.getElementById("sportPoint");
            sportPoint.style.top = -26 + "px";
            clearInterval(time)
            stopAnimation()
        })

    })


</script>
<th:block th:include="page/fragments/common :: mapinit_js"/>

</body>
</html>
